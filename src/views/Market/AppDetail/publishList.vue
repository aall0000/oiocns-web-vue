<template>
  <div class="managerApproval">
    <MarketCard> </MarketCard>
    <div class="tabList">
      <DiyTable
        ref="diyTable"
        :hasTitle="false"
        :tableData="state.data"
        :tableHead="state.tableHead"
        @handleUpdate="handleUpdate"
      >
            <template #operate="scope">
                <el-link type="primary" @click="showOrderList(scope.row.id)">售卖详情</el-link>
          </template>
      </DiyTable>
    </div>

    <el-dialog
      v-model="orderListDialog.show"
      append-to-body
      :before-close="closeDialog"
      :title="'售卖详情'"
    >
      <DiyTable
        :style="{height:500+'px',width:'100%'}"
        ref="diyTable2"
        :hasTitle="false"
        :tableData="dialogState.data"
        :tableHead="dialogState.tableHead"
        @handleUpdate="dialogHandleUpdate"
      >
      </DiyTable>
    </el-dialog>
  </div>
</template>
<script lang="ts" setup>
  import $services from '@/services'
  import { onMounted, reactive, ref } from 'vue'
  import MarketCard from '@/components/marketCard/index.vue'
  import { useRouter, useRoute } from 'vue-router'
  import { ElMessage } from 'element-plus'
  import DiyTable from '@/components/diyTable/index.vue'
  const router = useRouter()
  const route = useRoute()
  const diyTable = ref(null)
  const dialogState = reactive({
    data: [],
    tableHead: [

            {
              prop: 'code',
              label: '订单号'
            },
            {
              prop: 'caption',
              label: '名称'
            },
            {
              prop: 'belongName',
              label: '买方名称'
            },
            {
              prop: 'sellAuth',
              label: '售卖权属'
            },
            {
              prop: 'days',
              label: '使用期限'
            },
            {
              prop: 'price',
              label: '售卖价格'
            },
            {
              prop: 'createTime',
              label: '创建时间'
            },
          ],
    currentPage: 1,
    pageSize: 20,
    total: 0
  })
  const state = reactive({
    data: [],
    tableHead: [

            {
              prop: 'productCode',
              label: '应用编号'
            },
            {
              prop: 'productName',
              label: '应用名称'
            },
            {
              prop: 'productSource',
              label: '应用来源'
            },
            {
              prop: 'productAuthority',
              label: '应用权限'
            },
            {
              prop: 'productTypeName',
              label: '应用类型'
            },
            {
              prop: 'marketName',
              label: '市场名称'
            },
            {
              prop: 'marketCode',
              label: '市场编号'
            },
            {
                prop: 'sellAuth',
              label: '售卖权属'
            },
            {
              prop: 'price',
              label: '价格'
            },
            {
              prop: 'days',
              label: '使用期限'
            },
            {
              prop: 'createTime',
              label: '创建时间',
              width: '200'
            },
            {
                type: 'slot',
                label: '操作',
                fixed: 'right',
                align: 'center',
                width: '100',
                name: 'operate'
            }
          ],
    currentPage: 1,
    pageSize: 20,
    total: 0
  })
  const handleUpdate = (page: any) => {
    state.currentPage = page.currentPage
    state.pageSize = page.pageSize
    getTableList()
  }
const dialogHandleUpdate = (page: any) => {
    dialogState.currentPage = page.currentPage
    dialogState.pageSize = page.pageSize
    // getDialogTableList()
  }
  onMounted(() => {
    getTableList()
  })

const orderListDialog = reactive({ show: false, data: {} })
const closeDialog = ()=>{
    orderListDialog.show = false
}

const getDialogTableList = async(id:string)=>{
     await $services.order
      .searchMerchandiseSellList({
        data: {
          id: id,
          offset: (state.currentPage - 1) * state.pageSize,
          limit: state.pageSize,
          filter: ''
        }
      })
      .then((res: ResultType) => {
        if (res.success) {
          const { result = [], total = 0 } = res.data
          dialogState.data =  result?.map(
            (item: any) => {
              return {
                ...item
              }
            }
          )
          dialogState.total = total

        }
      })
}
const showOrderList = (id:string)=>{
    orderListDialog.show = true
   getDialogTableList(id)
}
  //查询上架申请
  const getTableList = async () => {
      state.data = []
    await $services.product
      .searchPublishList({
        data: {
          id: route.query.id,
          offset: (state.currentPage - 1) * state.pageSize,
          limit: state.pageSize,
          filter: ''
        }
      })
      .then((res: ResultType) => {

        if (res.success) {
          const { result = [], total = 0 } = res.data
          
          state.data = result?.map(
            (item: any) => {
              return {
                ...item,
                productCode: route.query.code,
                productName: route.query.name,
                productSource: route.query.source,
                productAuthority: route.query.authority,
                productTypeName: route.query.typeName,
                marketName: item.market.name,
                marketCode: item.market.code,
              }
            }
          )
          state.total = total
          diyTable.value.state.loading = false
          diyTable.value.state.page.total = state.total

        }
      })
  }
</script>

<style lang="scss" scoped>
  .managerApproval {
    width: 100%;
    height: 100%;
    background-color: var(--el-bg-color);
    .tabList {
      width: 100%;
      height: calc(100vh - 130px);
      padding-left: 16px;
    }
  }
</style>
