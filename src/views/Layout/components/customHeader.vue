<template>
  <el-row class="page-custom-header">
    <!-- 左侧 -->
    <el-col class="" :span="4">
      <img class="logo" src="@/assets/img/avatar.jpg" alt="logo" @click="toHome"/>
      <el-dropdown trigger="click" placement="bottom-start" ref="dropdown">
        <span class="el-dropdown-link" @click="onClickDrop">
          {{ workspaceData?.name || '' }}
          <el-icon>
            <CaretBottom />
          </el-icon>
        </span>
        <template #dropdown>
          <el-dropdown-menu
            v-infinite-scroll="load"
            infinite-scroll-immediate="false"
            infinite-scroll-distance="1"
            style="max-height: 300px; overflow: auto"
          >
            <el-dropdown-item
              v-for="item in store.userCompanys"
              :key="item.id"
              @click="switchCompany(item)"
              >{{ item.team ? item.team.name : item.name }}</el-dropdown-item
            >
          </el-dropdown-menu>
          <div class="joinBtn" @click="createCompany">+ 创建企业/单位/组织</div>
        </template>
      </el-dropdown>
    </el-col>
    <!-- 右侧 -->
    <el-col :span="12" class="col-center"
      ><el-popover trigger="click" :visible="visible" placement="bottom" :width="950">
        <template #reference>
          <el-input
            ref="searchRef"
            class="right-con"
            v-model="SearchInfo"
            :style="{ width: '100%', height: '40px' }"
            placeholder="请输⼊想搜索的功能"
          >
            <template #prepend>
              <el-button :icon="Search" @click="showSearchInfo" />
            </template>
          </el-input>
        </template>
        <SearchDialog></SearchDialog> </el-popover
    ></el-col>
    <el-col :span="8" class="flex col-right">
      <el-dropdown trigger="click">
        <span class="el-dropdown-link">
          <el-icon>
            <User />
          </el-icon>
          {{ queryInfo.name
          }}<el-icon>
            <CaretBottom />
          </el-icon>
        </span>
        <template #dropdown>
          <el-dropdown-menu>
            <el-dropdown-item>Action 1</el-dropdown-item>
            <el-dropdown-item> 语言切换 </el-dropdown-item>
            <el-dropdown-item>首页配置</el-dropdown-item>
            <el-dropdown-item @click="Setting">信息设置</el-dropdown-item>
            <el-dropdown-item>帮助中心</el-dropdown-item>
            <el-dropdown-item @click="exitLogin">退出登录</el-dropdown-item>
          </el-dropdown-menu>
        </template>
      </el-dropdown>
    </el-col>
  </el-row>
  <template v-for="item in dialogShow" :key="item.key">
    <CreateUnitDialog
      v-if="item.key == 'unit' && item.value"
      :dialogShow="item"
      @closeDialog="closeDialog"
      @switchCreateCompany="switchCreateCompany"
    ></CreateUnitDialog>
    <SearchDialog
      v-if="item.key == 'search' && item.value"
      :dialogShow="item"
      :search="SearchInfo"
      @closeDialog="closeDialog"
    ></SearchDialog>
  </template>
</template>

<script lang="ts" setup>
  import { ref, watch, onMounted, reactive } from 'vue'
  import { Search } from '@element-plus/icons-vue'
  import { storeToRefs } from 'pinia'
  import { useRouter } from 'vue-router'
  import { useUserStore } from '@/store/user'
  import $services from '@/services'
  import { ElMessage } from 'element-plus'
  import CreateUnitDialog from './createUnitDialog.vue'
  import SearchDialog from './searchDialog.vue'

  const store = useUserStore()
  const SearchInfo = ref('')
  const router = useRouter()
  let current = ref(0)
  const visible = ref(false)
  const showSearch = ref(false)
  const { queryInfo } = storeToRefs(store)
  const workspaceData = store.workspaceData
  const dropdown = ref()

  const load = () => {
    current.value++
    store.getCompanyList(current.value, workspaceData.id, true)
  }
  const dialogShow = reactive([
    {
      key: 'unit',
      value: false
    },
    {
      key: 'search',
      value: false
    }
  ])
  const toHome = () =>{
    router.push('/home')
  }
  const showSearchInfo = () => {
    visible.value = !visible.value
  }
  // const getFocus = () => {
  //   visible.value = true
  // }
  // const getBlur = () => {
  //   if (!showSearch.value) {
  //     visible.value = false
  //   }
  // }
  // const mouseenter = () => {
  //   showSearch.value = true
  // }
  // const mouseleave = () => {
  //   showSearch.value = false
  // }

  const createCompany = () => {
    dialogShow.map((el) => {
      if (el.key == 'unit') {
        el.value = true
        dropdown.value.handleClose()
      }
    })
  }
  const closeDialog = (key: string) => {
    dialogShow.map((el) => {
      if (el.key == key) {
        el.value = false
      }
    })
  }
  const onClickDrop = () => {
    if (store.userCompanys.length == 0) {
      current.value = 0
      store.getCompanyList(current.value, workspaceData.id, false)
    }
  }

  const switchCreateCompany = (data: { id: string }) => {
    $services.person
      .changeWorkspace({
        data: {
          id: data.id
        }
      })
      .then((res: ResultType) => {
        if (res.code == 200) {
          sessionStorage.setItem('TOKEN', res.data.accessToken)
          store.getQueryInfo(res.data.accessToken)
          current.value = 0
          store.createUnit(res.data).then(() => {
            location.reload()
          })
        } else {
          ElMessage({
            message: res.msg,
            type: 'warning'
          })
        }
      })
  }
  const switchCompany = (data: { id: string }) => {
    $services.person
      .changeWorkspace({
        data: {
          id: data.id
        }
      })
      .then((res: ResultType) => {
        if (res.code == 200) {
          sessionStorage.setItem('TOKEN', res.data.accessToken)

          store.getQueryInfo(res.data.accessToken)
          store.getWorkspaceData(res.data.workspaceId).then(() => {
            location.reload()
          })
        } else {
          ElMessage({
            message: res.msg,
            type: 'warning'
          })
        }
      })
  }
  const Setting = () => {
    if (store.workspaceData.name === '个人空间') {
      router.push('/user')
    } else {
      router.push('/company')
    }
  }
  const exitLogin = () => {
    sessionStorage.clear()
    store.resetState()
    router.push('/login')
  }
</script>

<style lang="scss" scoped>
  :deep(.el-popover.el-popper) {
    width: 100%;
  }
  .joinBtn {
    margin: 10px;
    display: flex;
    height: 32px;
    background: #ffffff;
    border-radius: 2px;
    border: 1px solid #d9d9d9;
    text-align: center;
    align-items: center;
    cursor: pointer;
    font-size: 12px;
    padding: 10px;

    color: rgba(0, 0, 0, 0.65);
  }
  .el-dropdown-link {
    cursor: pointer;
  }
  .page-custom-header {
    height: 60px;
    line-height: 60px;

    .el-col {
      display: flex;
      align-items: center;
    }

    .logo {
      margin-right: 10px;
    }
    .col-right {
      justify-content: flex-end;

      .right-con {
        margin-right: 18px;
      }
    }
  }
</style>
